"use strict";(self.webpackChunk_defra_flood_map=self.webpackChunk_defra_flood_map||[]).push([[118],{"./node_modules/@arcgis/core/views/3d/layers/graphics/placementUtils.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Ir:()=>m,QE:()=>f,RH:()=>u,Zd:()=>s,cN:()=>i,xU:()=>h});var _core_libs_gl_matrix_2_math_vec2_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@arcgis/core/core/libs/gl-matrix-2/math/vec2.js"),_core_libs_gl_matrix_2_factories_vec2f64_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@arcgis/core/core/libs/gl-matrix-2/factories/vec2f64.js"),_webgl_engine_lib_TextRenderer_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/lib/TextRenderer.js");const i=Object.freeze({left:0,center:.5,right:1}),s=Object.freeze({"bottom-left":(0,_core_libs_gl_matrix_2_factories_vec2f64_js__WEBPACK_IMPORTED_MODULE_1__.fA)(0,0),bottom:(0,_core_libs_gl_matrix_2_factories_vec2f64_js__WEBPACK_IMPORTED_MODULE_1__.fA)(.5,0),"bottom-right":(0,_core_libs_gl_matrix_2_factories_vec2f64_js__WEBPACK_IMPORTED_MODULE_1__.fA)(1,0),left:(0,_core_libs_gl_matrix_2_factories_vec2f64_js__WEBPACK_IMPORTED_MODULE_1__.fA)(0,.5),center:(0,_core_libs_gl_matrix_2_factories_vec2f64_js__WEBPACK_IMPORTED_MODULE_1__.fA)(.5,.5),right:(0,_core_libs_gl_matrix_2_factories_vec2f64_js__WEBPACK_IMPORTED_MODULE_1__.fA)(1,.5),"top-left":(0,_core_libs_gl_matrix_2_factories_vec2f64_js__WEBPACK_IMPORTED_MODULE_1__.fA)(0,1),top:(0,_core_libs_gl_matrix_2_factories_vec2f64_js__WEBPACK_IMPORTED_MODULE_1__.fA)(.5,1),"top-right":(0,_core_libs_gl_matrix_2_factories_vec2f64_js__WEBPACK_IMPORTED_MODULE_1__.fA)(1,1)});function f(t){switch(t){case"left":return _webgl_engine_lib_TextRenderer_js__WEBPACK_IMPORTED_MODULE_2__.lV.Left;case"right":return _webgl_engine_lib_TextRenderer_js__WEBPACK_IMPORTED_MODULE_2__.lV.Right;default:return _webgl_engine_lib_TextRenderer_js__WEBPACK_IMPORTED_MODULE_2__.lV.Center}}function m(t,e){switch(e){case"bottom":return"left"===t?"bottom-left":"right"===t?"bottom-right":"bottom";case"center":return t;case"top":return"left"===t?"top-left":"right"===t?"top-right":"top"}}function u(t){return"middle"===t?"center":t}function h(r,c){switch(r){case"top":return(0,_core_libs_gl_matrix_2_math_vec2_js__WEBPACK_IMPORTED_MODULE_0__.hZ)(c,0,_webgl_engine_lib_TextRenderer_js__WEBPACK_IMPORTED_MODULE_2__.Xd);case"bottom":return(0,_core_libs_gl_matrix_2_math_vec2_js__WEBPACK_IMPORTED_MODULE_0__.hZ)(c,0,-1);default:return(0,_core_libs_gl_matrix_2_math_vec2_js__WEBPACK_IMPORTED_MODULE_0__.C)(c,_core_libs_gl_matrix_2_factories_vec2f64_js__WEBPACK_IMPORTED_MODULE_1__.uY)}}},"./node_modules/@arcgis/core/views/3d/webgl-engine/lib/FontMetrics.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{z:()=>e});var _TextHelperCanvas_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/lib/TextHelperCanvas.js");function e(e){const{size:c}=e.definition,a=e.fontString(c);let i=n.get(a);if(!i){const u=(0,_TextHelperCanvas_js__WEBPACK_IMPORTED_MODULE_0__.y)(o,0,0).getContext("2d");e.setFontProperties(u,c);const x=u.measureText(r);i=new s(x.actualBoundingBoxAscent,x.actualBoundingBoxDescent),n.set(a,i)}return i}const n=new Map;class s{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(t,e){this.maxAscent=t,this.maxDescent=e}}const o={canvas:null},r=(()=>{let t="";for(let e=32;e<127;e++)t+=String.fromCharCode(e);return t})()},"./node_modules/@arcgis/core/views/3d/webgl-engine/lib/GLMaterials.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{c:()=>t});var _basicInterfaces_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/lib/basicInterfaces.js");class t{constructor(s,t){this._material=s,this._repository=t,this._map=new Map}dispose(){this._map.forEach(((s,t)=>{null!=s&&this._repository.release(this._material,t)}))}load(t,e,r){const i=this._material.produces.get(e);if(!i?.(r))return null;this._map.has(r)||this._map.set(r,this._repository.acquire(this._material,e,r));const a=this._map.get(r);if(null!=a){if(a.ensureResources(t)===_basicInterfaces_js__WEBPACK_IMPORTED_MODULE_0__.Am.LOADED)return a;this._repository.requestRender()}return null}}},"./node_modules/@arcgis/core/views/3d/webgl-engine/lib/TextHelperCanvas.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function a(a,n,c){return a.canvas||(a.canvas=document.createElement("canvas")),a.canvas.width=n,a.canvas.height=c,a.canvas}__webpack_require__.d(__webpack_exports__,{y:()=>a})},"./node_modules/@arcgis/core/views/3d/webgl-engine/lib/TextRenderer.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Js:()=>r,Xd:()=>s,lV:()=>o});var _core_mathUtils_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@arcgis/core/core/mathUtils.js"),_support_debugFlags_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@arcgis/core/views/3d/support/debugFlags.js"),_FontMetrics_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/lib/FontMetrics.js"),_TextHelperCanvas_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/lib/TextHelperCanvas.js");const s=1;class r{constructor(t,e,i,n){this.text=t,this._alignment=e,this._parameters=i,this._maxSize=n,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${t}--${this._parameters.key}-${this._alignment}`,this._lines=t.replaceAll(" ","Â ").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let t=this._metrics.firstLineAscent;for(let e=0;e<this._lines.length-1;e++)t+=this._lineSpacing;return t+=this._metrics.lastLineDescent,Math.ceil(t+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(null==this._metricsCached){const t=(0,_TextHelperCanvas_js__WEBPACK_IMPORTED_MODULE_3__.y)(a,l,l).getContext("2d"),e=this._parameters.definition.pixelRatio,s=this._fontSize*e;this._parameters.setFontProperties(t,s);let r=2*this._haloSize;const h=this._parameters.definition.font;"italic"!==h.style&&"oblique"!==h.style&&"bold"!==h.weight&&"bolder"!==h.weight||(r+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let o=0,d=0,_=0,g=0,m=0;this._lines.forEach(((i,n)=>{const s=t.measureText(i),h=s.width/e,a=h+r;this._textWidths.push(h),this._lineWidths.push(a),o=Math.max(o,a),g=Math.max(g,s.actualBoundingBoxAscent/e),m=Math.max(m,s.actualBoundingBoxDescent/e),0===n&&(d=s.actualBoundingBoxAscent/e),n===this._lines.length-1&&(_=s.actualBoundingBoxDescent/e)}));const f=(0,_FontMetrics_js__WEBPACK_IMPORTED_MODULE_2__.z)(this._parameters),u=Math.max(g,f.maxAscent),p=Math.max(m,f.maxDescent),x=d,R="underline"===this._parameters.definition.font.decoration?p:_,S=o;this._metricsCached=new c(x,R,u,p,S)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*d}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,s)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(null==this._renderPixelRatio){const t=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(t,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(t){switch(this._alignment){case o.Left:return this._horizontalPadding;case o.Center:return(this.displayWidth-this._lineWidths[t])/2;case o.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[t]}}render(t,i,n){t.save();const s=i/=this.renderPixelRatio,r=n/=this.renderPixelRatio,h=this._haloSize,o=this._firstLineYOffset+this._metrics.firstLineAscent;i+=h,n+=o;const a=this._haloSize>0;a&&this._renderHalo(t,s,r,h,o),this._parameters.setFontProperties(t,this._renderedFontSize);for(let e=0;e<this._lines.length;++e){const s=this._lines[e],r=this._getLineXOffset(e);a&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,s,i+r,n),this._renderLineDecoration(t,i+r,n,this._textWidths[e])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,s,i+this._getLineXOffset(e),n),this._renderLineDecoration(t,i+r,n,this._textWidths[e]),n+=this._lineSpacing}if(_support_debugFlags_js__WEBPACK_IMPORTED_MODULE_1__.b.TEXT_SHOW_BASELINE){t.strokeStyle=_,t.setLineDash([2,2]),t.lineWidth=1;let e=r+o;for(let i=0;i<this._lines.length;++i)this._drawLine(t,[s,e],[s+this.displayWidth,e]),e+=this._lineSpacing}if(_support_debugFlags_js__WEBPACK_IMPORTED_MODULE_1__.b.TEXT_SHOW_BORDER&&(t.strokeStyle=_,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[s,r],[this.displayWidth,this.displayHeight])),this._hasBackground){const e=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,s,r,e),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill()}t.restore()}_renderLineDecoration(t,e,i,n,s=!1){if("none"===this._parameters.definition.font.decoration||0===n)return;const h=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":i+=2*h;break;case"line-through":i-=.33*this._midLineAscent}const o=s?this._haloSize:0;t.strokeStyle=s?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(h+2*o),t.beginPath(),t.moveTo(this._toRenderUnit(e-o),this._toRenderUnit(i)),t.lineTo(this._toRenderUnit(e+n+o),this._toRenderUnit(i)),t.stroke()}_roundedRect(e,i,n,s){i=this._toRenderUnit(i),n=this._toRenderUnit(n);const r=this.renderedWidth,h=this.renderedHeight;0!==s?(s=(0,_core_mathUtils_js__WEBPACK_IMPORTED_MODULE_0__.qE)(s,0,Math.floor(h/2)),e.beginPath(),e.moveTo(i,n+s),e.arcTo(i,n,i+s,n,s),e.lineTo(i+r-s,n),e.arcTo(i+r,n,i+r,n+s,s),e.lineTo(i+r,n+h-s),e.arcTo(i+r,n+h,i+r-s,n+h,s),e.lineTo(i+s,n+h),e.arcTo(i,n+h,i,n+h-s,s),e.closePath()):e.rect(i,n,r,h)}_renderHalo(t,e,i,s,r){const h=this.renderedWidth,o=this.renderedHeight,d=(0,_TextHelperCanvas_js__WEBPACK_IMPORTED_MODULE_3__.y)(a,Math.max(h,l),Math.max(o,l)),_=d.getContext("2d");_.clearRect(0,0,h,o),this._parameters.setFontProperties(_,this._renderedFontSize),_.fillStyle=this._parameters.haloStyle,_.strokeStyle=this._parameters.haloStyle;const c=this._renderedHaloSize<3;_.lineJoin=c?"miter":"round",c?this._renderHaloEmulated(_,s,r):this._renderHaloNative(_,s,r);let g=r;for(let n=0;n<this._lines.length;++n){const t=this._getLineXOffset(n);this._renderLineDecoration(_,s+t,g,this._textWidths[n],!0),g+=this._lineSpacing}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(d,0,0,h,o,this._toRenderUnit(e),this._toRenderUnit(i),h,o),t.globalAlpha=1}_renderHaloEmulated(t,e,i){for(let n=0;n<this._lines.length;++n){const s=this._lines[n],r=this._getLineXOffset(n);for(const[n,o]of h)this._fillText(t,s,e+r+this._haloSize*n,i+this._haloSize*o);i+=this._lineSpacing}}_renderHaloNative(t,e,i){const n=2*this._haloSize;for(let s=0;s<this._lines.length;++s){const r=this._lines[s],h=this._getLineXOffset(s),o=5,a=.1;for(let s=0;s<o;s++){const d=1-(o-1)*a+s*a;t.lineWidth=this._toRenderUnit(d*n),this._strokeText(t,r,e+h,i)}i+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(t){return t*this.renderPixelRatio}_toRoundedRenderUnit(t){return Math.round(t*this.renderPixelRatio)}_fillText(t,e,i,n){t.fillText(e,this._toRenderUnit(i),this._toRenderUnit(n))}_strokeText(t,e,i,n){t.strokeText(e,this._toRenderUnit(i),this._toRenderUnit(n))}_drawLine(t,e,i){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(e[0])+.5,this._toRoundedRenderUnit(e[1])+.5),t.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),t.stroke()}_drawBox(t,e,i){const n=this._toRenderUnit(e[0]),s=this._toRenderUnit(e[1]),r=this._toRenderUnit(i[0]),h=this._toRenderUnit(i[1]),o=Math.floor(n)+.5,a=Math.ceil(n+r)-.5,d=Math.floor(s)+.5,l=Math.ceil(s+h)-.5;t.beginPath(),t.moveTo(o,d),t.lineTo(a,d),t.lineTo(a,l),t.lineTo(o,l),t.lineTo(o,d),t.stroke()}}const h=[];{const t=16;for(let e=0;e<360;e+=360/t)h.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}var o,t;(t=o||(o={}))[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right";const a={canvas:null},d=.2,l=512,_="rgb(255, 0, 255, 0.5)";class c{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(t,e,i,n,s){this.firstLineAscent=t,this.lastLineDescent=e,this.maxLineAscent=i,this.maxLineDescent=n,this.displayWidth=s}}},"./node_modules/@arcgis/core/views/3d/webgl-engine/lib/lodRendering/LodRenderer.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{L:()=>k});var tslib_es6=__webpack_require__("./node_modules/@arcgis/core/chunks/tslib.es6.js"),arrayUtils=__webpack_require__("./node_modules/@arcgis/core/core/arrayUtils.js"),Error=__webpack_require__("./node_modules/@arcgis/core/core/Error.js"),MapUtils=__webpack_require__("./node_modules/@arcgis/core/core/MapUtils.js"),maybe=__webpack_require__("./node_modules/@arcgis/core/core/maybe.js"),promiseUtils=__webpack_require__("./node_modules/@arcgis/core/core/promiseUtils.js"),property=__webpack_require__("./node_modules/@arcgis/core/core/accessorSupport/decorators/property.js"),subclass=(__webpack_require__("./node_modules/@arcgis/core/core/has.js"),__webpack_require__("./node_modules/@arcgis/core/core/Logger.js"),__webpack_require__("./node_modules/@arcgis/core/core/accessorSupport/decorators/subclass.js")),mat4f64=__webpack_require__("./node_modules/@arcgis/core/core/libs/gl-matrix-2/factories/mat4f64.js"),vec32=__webpack_require__("./node_modules/@arcgis/core/chunks/vec32.js"),vec3f64=__webpack_require__("./node_modules/@arcgis/core/core/libs/gl-matrix-2/factories/vec3f64.js"),vec4f64=__webpack_require__("./node_modules/@arcgis/core/core/libs/gl-matrix-2/factories/vec4f64.js"),debugFlags=__webpack_require__("./node_modules/@arcgis/core/views/3d/support/debugFlags.js"),glUtil=__webpack_require__("./node_modules/@arcgis/core/views/3d/support/buffer/glUtil.js"),InterleavedLayout=__webpack_require__("./node_modules/@arcgis/core/views/3d/support/buffer/InterleavedLayout.js"),RenderCamera=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl/RenderCamera.js"),ShaderOutput=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/core/shaderLibrary/ShaderOutput.js"),RenderPlugin=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/effects/RenderPlugin.js"),DefaultVertexAttributeLocations=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/lib/DefaultVertexAttributeLocations.js");class DepthRange_r{constructor(r=1/0,t=-1/0){this.near=r,this.far=t}set(r,t){this.near=r,this.far=t}union(r){null!=r&&(this.near=Math.min(this.near,r.near),this.far=Math.max(this.far,r.far))}within(r){return this.near<=r&&r<=this.far}}DepthRange_r.zero=new DepthRange_r(0,0);var IntersectorInterfaces=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/lib/IntersectorInterfaces.js"),Octree=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/lib/Octree.js"),RenderSlot=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/lib/RenderSlot.js"),Util=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/lib/Util.js"),VertexAttribute=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/lib/VertexAttribute.js"),Accessor=__webpack_require__("./node_modules/@arcgis/core/core/Accessor.js"),Evented=__webpack_require__("./node_modules/@arcgis/core/core/Evented.js"),mat3=__webpack_require__("./node_modules/@arcgis/core/core/libs/gl-matrix-2/math/mat3.js"),mat3f64=__webpack_require__("./node_modules/@arcgis/core/core/libs/gl-matrix-2/factories/mat3f64.js"),mat4=__webpack_require__("./node_modules/@arcgis/core/core/libs/gl-matrix-2/math/mat4.js"),BufferView=__webpack_require__("./node_modules/@arcgis/core/geometry/support/buffer/BufferView.js"),mathUtils=__webpack_require__("./node_modules/@arcgis/core/views/3d/support/mathUtils.js"),BufferObject=__webpack_require__("./node_modules/@arcgis/core/views/webgl/BufferObject.js"),enums=__webpack_require__("./node_modules/@arcgis/core/views/webgl/enums.js");class r{constructor(r,i,s){this._elementSize=i,this._buffer=BufferObject.g.createVertex(r,enums._U.STATIC_DRAW),this.resize(s)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,t,r,i=0){const s=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(r.array,i*this.elementSize).set(s)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const r=e*this._elementSize,i=t*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),r,r,i)}resize(e){const t=e*this._elementSize,r=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(r).set(new Uint8Array(this._array)):new Uint8Array(r).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=r,this._buffer.setSize(t),this._capacity=e}}class c{constructor(t){this.modelOriginHi=t.getField(VertexAttribute.r.INSTANCEMODELORIGINHI,BufferView.xs),this.modelOriginLo=t.getField(VertexAttribute.r.INSTANCEMODELORIGINLO,BufferView.xs),this.model=t.getField(VertexAttribute.r.INSTANCEMODEL,BufferView.jZ),this.modelNormal=t.getField(VertexAttribute.r.INSTANCEMODELNORMAL,BufferView.jZ),this.featureAttribute=t.getField(VertexAttribute.r.INSTANCEFEATUREATTRIBUTE,BufferView.Eq),this.color=t.getField(VertexAttribute.r.INSTANCECOLOR,BufferView.XP),this.objectAndLayerIdColor=t.getField(VertexAttribute.r.INSTANCEOBJECTANDLAYERIDCOLOR,BufferView.XP)}}class f{constructor(t,i){this._rctx=t,this._instanceBufferLayout=i,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const t=this._headIndex,i=this._tailIndex;return t>=i?t-i:t+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){(0,Util.vA)(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){(0,Util.vA)(this._updating,"not updating"),this.size<arrayUtils.$U*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){(0,Util.vA)(this._updating,"not updating"),this.isFull&&this._grow();const t=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=t,this._captureFirstIndex=!1),this._incrementHead(),(0,Util.vA)(this._headIndex!==this._tailIndex,"invalid pointers"),t}freeTail(){(0,Util.vA)(this._updating,"not updating"),(0,Util.vA)(this.size>0,"invalid size");const t=this._tailIndex===this._firstIndex;this._incrementTail(),t&&(this._firstIndex=this._tailIndex)}_grow(){const t=Math.max(u,Math.floor(this._capacity*arrayUtils.Ji));this._resize(t)}_shrink(){const t=Math.max(u,Math.floor(this._capacity*arrayUtils.He));this._resize(t)}_resize(t){if((0,Util.vA)(this._updating,"not updating"),t===this._capacity)return;const i=new r(this._rctx,this._instanceBufferLayout.stride,t);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const t=this.size,e=this._compactInstances(i);(0,Util.vA)(e===t,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=e,this._prevHeadIndex=0}this._resized=!0,this._capacity=t,this._buffer=i,this._view=new c(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(t){const i=this._headIndex,e=this._tailIndex;return e<i?(this._buffer.copyRange(e,i,t),i-e):e>i?(this._buffer.copyRange(e,this._capacity,t),i>0&&this._buffer.copyRange(0,i,t,this._capacity-e),i+(this._capacity-e)):0}_incrementHead(t=1){this._headIndex=(this._headIndex+t)%this._capacity}_incrementTail(t=1){this._tailIndex=(this._tailIndex+t)%this._capacity}_transferRange(t,i){t<i?this._buffer.transferRange(t,i):t>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(t,this._capacity))}}const u=64;var S,t;(t=S||(S={}))[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE";class R{constructor(t){this.localTransform=t.getField(VertexAttribute.r.LOCALTRANSFORM,BufferView.E$),this.globalTransform=t.getField(VertexAttribute.r.GLOBALTRANSFORM,BufferView.E$),this.modelOrigin=t.getField(VertexAttribute.r.MODELORIGIN,BufferView.Xm),this.model=t.getField(VertexAttribute.r.INSTANCEMODEL,BufferView.jZ),this.modelNormal=t.getField(VertexAttribute.r.INSTANCEMODELNORMAL,BufferView.jZ),this.modelScaleFactors=t.getField(VertexAttribute.r.MODELSCALEFACTORS,BufferView.gH),this.boundingSphere=t.getField(VertexAttribute.r.BOUNDINGSPHERE,BufferView.Aj),this.featureAttribute=t.getField(VertexAttribute.r.FEATUREATTRIBUTE,BufferView.Eq),this.color=t.getField(VertexAttribute.r.COLOR,BufferView.XP),this.objectAndLayerIdColor=t.getField(VertexAttribute.r.OBJECTANDLAYERIDCOLOR,BufferView.XP),this.state=t.getField(VertexAttribute.r.STATE,BufferView.SL),this.lodLevel=t.getField(VertexAttribute.r.LODLEVEL,BufferView.SL)}}let b=class extends Accessor.A{constructor(t,e){super(t),this.events=new Evented.A,this._capacity=0,this._size=0,this._next=0,this._highlightOptionsMap=new Map,this._highlightOptionsMapPrev=new Map,this._layout=function C(t){let e=(0,InterleavedLayout.BP)().mat4f64(VertexAttribute.r.LOCALTRANSFORM).mat4f64(VertexAttribute.r.GLOBALTRANSFORM).vec4f64(VertexAttribute.r.BOUNDINGSPHERE).vec3f64(VertexAttribute.r.MODELORIGIN).mat3f(VertexAttribute.r.INSTANCEMODEL).mat3f(VertexAttribute.r.INSTANCEMODELNORMAL).vec2f(VertexAttribute.r.MODELSCALEFACTORS);return t.includes(VertexAttribute.r.FEATUREATTRIBUTE)&&(e=e.vec4f(VertexAttribute.r.FEATUREATTRIBUTE)),t.includes(VertexAttribute.r.COLOR)&&(e=e.vec4u8(VertexAttribute.r.COLOR)),t.includes(VertexAttribute.r.OBJECTANDLAYERIDCOLOR)&&(e=e.vec4u8(VertexAttribute.r.OBJECTANDLAYERIDCOLOR)),e=e.u8(VertexAttribute.r.STATE).u8(VertexAttribute.r.LODLEVEL),e}(e),this._capacity=u,this._buffer=this._layout.createBuffer(this._capacity),this._view=new R(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const t=this._findSlot();return this._view.state.set(t,S.ALLOCATED),this._size++,this.events.emit("instances-changed"),t}removeInstance(t){const e=this._view.state;(0,Util.vA)(t>=0&&t<this._capacity&&!!(e.get(t)&S.ALLOCATED),"invalid instance handle"),this._getStateFlag(t,S.ACTIVE)?this._setStateFlags(t,S.REMOVE):this.freeInstance(t),this.events.emit("instances-changed")}freeInstance(t){const e=this._view.state;(0,Util.vA)(t>=0&&t<this._capacity&&!!(e.get(t)&S.ALLOCATED),"invalid instance handle"),e.set(t,0),this._size--}setLocalTransform(t,e,s=!0){this._view.localTransform.setMat(t,e),s&&this.updateModelTransform(t)}getLocalTransform(t,e){this._view.localTransform.getMat(t,e)}setGlobalTransform(t,e,s=!0){this._view.globalTransform.setMat(t,e),s&&this.updateModelTransform(t)}getGlobalTransform(t,e){this._view.globalTransform.getMat(t,e)}updateModelTransform(t){const e=this._view,s=y,i=N;e.localTransform.getMat(t,D),e.globalTransform.getMat(t,H);const a=(0,mat4.lw)(H,H,D);(0,vec32.i)(s,a[12],a[13],a[14]),e.modelOrigin.setVec(t,s),(0,mat3.z0)(i,a),e.model.setMat(t,i);const r=(0,mathUtils.wp)(y,a);r.sort(),e.modelScaleFactors.set(t,0,r[1]),e.modelScaleFactors.set(t,1,r[2]),(0,mat3.B8)(i,i),(0,mat3.mg)(i,i),e.modelNormal.setMat(t,i),this._setStateFlags(t,S.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:t})}getModelTransform(t,e){const s=this._view;s.model.getMat(t,N),s.modelOrigin.getVec(t,y),e[0]=N[0],e[1]=N[1],e[2]=N[2],e[3]=0,e[4]=N[3],e[5]=N[4],e[6]=N[5],e[7]=0,e[8]=N[6],e[9]=N[7],e[10]=N[8],e[11]=0,e[12]=y[0],e[13]=y[1],e[14]=y[2],e[15]=1}applyShaderTransformation(t,e){null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedModelTransform(t,e){return this.getModelTransform(t,e),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,t,e),e}getCombinedLocalTransform(t,e){this._view.localTransform.getMat(t,e),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedMaxScaleFactor(t){let e=this._view.modelScaleFactors.get(t,1);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(y,this,t),e*=Math.max(y[0],y[1],y[2])),e}getCombinedMedianScaleFactor(t){let e=this._view.modelScaleFactors.get(t,0);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(y,this,t),e*=function w(t,e,s){return Math.max(Math.min(t,e),Math.min(Math.max(t,e),s))}(y[0],y[1],y[2])),e}getModel(t,e){this._view.model.getMat(t,e)}setFeatureAttribute(t,e){this._view.featureAttribute.setVec(t,e)}getFeatureAttribute(t,e){this._view.featureAttribute.getVec(t,e)}setColor(t,e){this._view.color.setVec(t,e)}setObjectAndLayerIdColor(t,e){this._view.objectAndLayerIdColor.setVec(t,e)}setVisible(t,e){e!==this.getVisible(t)&&(this._setStateFlag(t,S.VISIBLE,e),this.events.emit("instance-visibility-changed",{index:t}))}getVisible(t){return this._getStateFlag(t,S.VISIBLE)}setHighlight(t,e){const{_highlightOptionsMap:s}=this,i=s.get(t);e?e!==i&&(s.set(t,e),this._setStateFlag(t,S.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed")):i&&(s.delete(t),this._setStateFlag(t,S.HIGHLIGHT,!1),this.events.emit("instance-highlight-changed"))}get highlightOptionsMap(){return this._highlightOptionsMap}getHighlightStateFlag(t){return this._getStateFlag(t,S.HIGHLIGHT)}geHighlightOptionsPrev(t){const e=this._highlightOptionsMapPrev.get(t)??null;return this._highlightOptionsMapPrev.delete(t),e}getHighlightName(t){const e=this.highlightOptionsMap.get(t)??null;return e?this._highlightOptionsMapPrev.set(t,e):this._highlightOptionsMapPrev.delete(t),e}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let e=0;for(let s=0;s<this._capacity;++s)this.getState(s)&t&&++e;return e}_setStateFlags(t,e){const s=this._view.state;e=s.get(t)|e,s.set(t,e)}_clearStateFlags(t,e){const s=this._view.state;e=s.get(t)&~e,s.set(t,e)}_setStateFlag(t,e,s){s?this._setStateFlags(t,e):this._clearStateFlags(t,e)}_getStateFlag(t,e){return!!(this._view.state.get(t)&e)}_grow(){this._capacity=Math.max(u,Math.floor(this._capacity*arrayUtils.Ji)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new R(this._buffer)}_findSlot(){const t=this._view.state;let e=this._next;for(;t.get(e)&S.ALLOCATED;)e=e+1===this._capacity?0:e+1;return this._next=e+1===this._capacity?0:e+1,e}};(0,tslib_es6._)([(0,property.MZ)({constructOnly:!0})],b.prototype,"shaderTransformation",void 0),(0,tslib_es6._)([(0,property.MZ)()],b.prototype,"_size",void 0),(0,tslib_es6._)([(0,property.MZ)({readOnly:!0})],b.prototype,"size",null),b=(0,tslib_es6._)([(0,subclass.$)("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],b);const y=(0,vec3f64.vt)(),N=(0,mat3f64.vt)(),D=(0,mat4f64.vt)(),H=(0,mat4f64.vt)();var sphere=__webpack_require__("./node_modules/@arcgis/core/chunks/sphere.js");class n extends Octree.A{constructor(e,r){super((t=>(0,sphere.w)(this._instanceData.view.boundingSphere.getVec(t,this._tmpSphere))),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=r,this._tmpSphere=(0,sphere.c)(),this._tmpMat4=(0,mat4f64.vt)()}addInstance(t){const s=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(t,this._tmpMat4);(0,vec32.t)((0,sphere.a)(this._tmpSphere),this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*(0,mathUtils.hG)(i),s.setVec(t,this._tmpSphere),this.add([t])}removeInstance(t){this.remove([t])}}class LevelSelector_e{constructor(e,i){this._worldSpaceRadius=e,this._minScreenSpaceRadii=i}selectLevel(e,i,t){const c=t.computeScreenPixelSizeAt(e),r=this._worldSpaceRadius*i/c;let s=0;for(let a=1;a<this._minScreenSpaceRadii.length;++a)r>=this._minScreenSpaceRadii[a]&&(s=a);return s}}var aaBoundingBox=__webpack_require__("./node_modules/@arcgis/core/geometry/support/aaBoundingBox.js"),GLMaterials=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/lib/GLMaterials.js"),VertexArrayObject=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/lib/VertexArrayObject.js");class LodComponentData_a{constructor(a,n){const m=a.renderContext.rctx,u=n.geometry,f=n.geometry.getRenderGeometry(),g=f.material;this._materials=a.materials,g.setParameters({instancedDoublePrecision:!0}),this.geometry=u,this.material=g,this.glMaterials=new GLMaterials.c(g,this._materials),this.vertexBufferLayout=f.vertexBufferLayout,this.vbo=BufferObject.g.createVertex(m,enums._U.STATIC_DRAW,f.buffer),this.vao=new VertexArrayObject.Z(m,DefaultVertexAttributeLocations.D,new Map([["geometry",(0,glUtil.U)(f.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=f.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,t,r,o,s,i,a,n){return this.geometry.intersect(e,t,r,o,s,i,a,n)}}class a{static async create(e,r,i){const s=await Promise.allSettled(r.components.map((o=>e.controller.schedule((()=>new LodComponentData_a(e,o)),i)))),c=s.map((o=>"fulfilled"===o.status?o.value:null)).filter(arrayUtils.Ru);if((0,promiseUtils.G4)(i)||c.length!==s.length){c.forEach((o=>o.destroy())),(0,promiseUtils.Te)(i);for(const o of s)if("rejected"===o.status)throw o.reason}return new a(r.minScreenSpaceRadius,c)}constructor(o,n){this.minScreenSpaceRadius=o,this.components=n}destroy(){this.components.forEach((o=>o.destroy()))}intersect(o,n,t,e,r,i,s){this.components.forEach((c=>c.intersect(o,n,t,e,r,i,this.boundingSphere,s)))}get boundingBox(){if(null==this._boundingBox){const o=(0,aaBoundingBox.Ie)();this.components.forEach((n=>{null!=n.boundingInfo&&((0,aaBoundingBox.iT)(o,n.boundingInfo.bbMin),(0,aaBoundingBox.iT)(o,n.boundingInfo.bbMax))})),this._boundingBox=o}return this._boundingBox}get boundingSphere(){if(null==this._boundingSphere){const o=this.boundingBox,n=(0,vec3f64.vt)();(0,aaBoundingBox.gX)(o,n),this._boundingSphere={center:n,radius:.5*(0,aaBoundingBox._F)(o)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((o,n)=>o+n.triangleCount),0)}}var MaterialUtil=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/materials/internal/MaterialUtil.js"),utils=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/materials/renderers/utils.js"),DefaultMaterialTechnique=__webpack_require__("./node_modules/@arcgis/core/views/3d/webgl-engine/shaders/DefaultMaterialTechnique.js"),HighlightDefaults=__webpack_require__("./node_modules/@arcgis/core/views/support/HighlightDefaults.js"),Scheduler=__webpack_require__("./node_modules/@arcgis/core/views/support/Scheduler.js"),webgl_Util=__webpack_require__("./node_modules/@arcgis/core/views/webgl/Util.js");let k=class extends RenderPlugin.Cc{constructor(e,t){super(e),this.type=IntersectorInterfaces.dz.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new RenderCamera.A,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[RenderSlot.N.OPAQUE_MATERIAL,e=>this._produces(e)],[RenderSlot.N.TRANSPARENT_MATERIAL,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new b({shaderTransformation:e.shaderTransformation},e.optionalFields),this.addHandles(t.registerTask(Scheduler.W6.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=function Y(e){let t=(0,InterleavedLayout.BP)().vec3f(VertexAttribute.r.INSTANCEMODELORIGINHI).vec3f(VertexAttribute.r.INSTANCEMODELORIGINLO).mat3f(VertexAttribute.r.INSTANCEMODEL).mat3f(VertexAttribute.r.INSTANCEMODELNORMAL);return null!=e&&e.includes("featureAttribute")&&(t=t.vec4f(VertexAttribute.r.INSTANCEFEATUREATTRIBUTE)),null!=e&&e.includes("color")&&(t=t.vec4u8(VertexAttribute.r.INSTANCECOLOR)),null!=e&&e.includes("objectAndLayerIdColor")&&(t=t.vec4u8(VertexAttribute.r.INSTANCEOBJECTANDLAYERIDCOLOR)),t}(this.optionalFields),this._glInstanceBufferLayout=(0,glUtil.U)(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",(()=>this._requestUpdateCycle())),this._instanceData.events.on("instance-transform-changed",(({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)})),this._instanceData.events.on("instance-visibility-changed",(({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)})),this._instanceData.events.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0)))])}get _allRenderInstanceData(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDataMap)e.push(t[1]);return e}get _allRenderInstanceDataExceptHighlightShadow(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDataMap)t[0]!==HighlightDefaults.Tv&&e.push(t[1]);return e}hasHighlightOptions(e){return this._highlightRenderInstanceDataMap.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get hasEmissions(){return this._levels.some((e=>e.components.some((e=>e.material.hasEmissions))))}get usedMemory(){return this._allRenderInstanceData.reduce(((e,t)=>t.reduce(((e,t)=>e+t.usedMemory),e)),this._levels.reduce(((e,t)=>e+t.components.reduce(((e,t)=>e+t.usedMemory),0)),0))}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,r)=>{const n=this._allRenderInstanceData[0][r].size+this._allRenderInstanceData[1][r].size,s=e.triangleCount;t.push({renderedInstances:n,renderedTriangles:n*s,trianglesPerInstance:s})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}_createRenderInstanceDataArray(e=[]){const{rctx:t}=this._context.renderContext;return this.symbol.levels.map((r=>{e.push(new f(t,this._instanceBufferLayout))})),e}async initializeRenderContext(e,r){this._context=e,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);const n=await Promise.allSettled(this.symbol.levels.map((t=>a.create(e,t,r)))),s=n.map((e=>"fulfilled"===e.status?e.value:null)).filter(arrayUtils.Ru);if((0,promiseUtils.G4)(r)||s.length!==n.length){s.forEach((e=>e.destroy())),(0,promiseUtils.Te)(r);for(const e of n)if("rejected"===e.status)throw e.reason}this._levels=s,this._levelSelector=(e=>{const t=e.baseBoundingSphere.radius,r=e.levels.map((e=>e.minScreenSpaceRadius));return new LevelSelector_e(t,r)})(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceDataMap.forEach((e=>e.forEach((e=>e.destroy()))))}_hasTransparentLevels(){return this._levels.some((e=>e.components.some((e=>{const t=e.material.produces.get(RenderSlot.N.TRANSPARENT_MATERIAL);return t?.(ShaderOutput.V.Color)}))))}hasHighlights(){return(0,MapUtils.Bs)(this._highlightRenderInstanceDataMap,(e=>e.some((e=>e.size>0))))}_produces(e){return(e!==ShaderOutput.V.Highlight||this.hasHighlights())&&(e!==ShaderOutput.V.ShadowHighlight||this.hasHighlightOptions(HighlightDefaults.Tv))}prepareRender(e){if(!debugFlags.b.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Scheduler.Bb),this._needFullCycle=!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;const t=this._getInstanceDatas(e);if(!t)return null;const r=new Array,n=this.levels;return t.forEach((t=>n.forEach((({components:n},s)=>n.forEach((n=>r.push(this._beginComponent(e,t[s],n)))))))),r}render(e,t){const r=this._getInstanceDatas(e);if(!r||null==t)return;let n=0;e.rctx.bindVAO();const s=this.levels;r.forEach((r=>s.forEach((({components:s},a)=>s.forEach((s=>this._renderComponent(e,t[n++],r[a],s,a)))))))}_getInstanceDatas(e){const{output:t,bind:r}=e,n=t===ShaderOutput.V.Highlight,s=t===ShaderOutput.V.ShadowHighlight,a=!n&&!s,i=t!==ShaderOutput.V.ShadowExcludeHighlight;if(a)return i?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;if(i){if(n){const e=r.highlight?.name;if(!e)return null;const t=this._highlightRenderInstanceDataMap.get(e);return t?[t]:null}const e=this._highlightRenderInstanceDataMap.get(HighlightDefaults.Tv);return s?e?[e]:null:Array.from(this._highlightRenderInstanceDataMap.values())}return null}intersect(e,t,r,n){if(!this.baseMaterial.visible||null==this._octree)return;const s=(0,vec3f64.vt)();(0,vec32.d)(s,n,r);const a=s=>{this._instanceData.getCombinedModelTransform(s,Z),e.transform.set(Z),(0,vec32.t)($,r,e.transform.inverse),(0,vec32.t)(X,n,e.transform.inverse);const a=this._instanceData.getState(s),i=this._instanceData.getLodLevel(s),o=this._levels.length;(0,Util.vA)(!!(a&S.ACTIVE),"invalid instance state"),(0,Util.vA)(i>=0&&i<o,"invaid lod level"),this._levels[i].intersect(e,t,$,X,s,this.metadata,o)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(a):this._octree.forEachAlongRay(r,s,a)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){const e=this._instanceData,t=e.view?.state;if(!t)return null;this._octreeCached=new n(e,this.baseBoundingSphere);for(let r=0;r<e.capacity;++r)t.get(r)&S.ACTIVE&&this._octreeCached.addInstance(r)}return this._octreeCached}_invalidateOctree(){this._octreeCached=(0,maybe.pR)(this._octreeCached)}queryDepthRange(e){if(null==this._octree)return new DepthRange_r;const t=e.viewForward,r=this._octree.findClosest(t,Octree.A.DepthOrder.FRONT_TO_BACK,e.frustum),n=this._octree.findClosest(t,Octree.A.DepthOrder.BACK_TO_FRONT,e.frustum);if(null==r||null==n)return new DepthRange_r;const s=e.eye,a=this._instanceData.view;a.boundingSphere.getVec(r,Q),(0,vec32.d)(Q,Q,s);const i=(0,vec32.f)(Q,t)-Q[3];a.boundingSphere.getVec(n,Q),(0,vec32.d)(Q,Q,s);const o=(0,vec32.f)(Q,t)+Q[3];return new DepthRange_r(i,o)}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.startUpdateCycle()))))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:n,_levelSelector:a}=this;this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.beginUpdate()))));const i=this._instanceData,o=i.view;let l=i.size;const c=i.capacity;let h=this._instanceIndex;const d=Math.ceil(c/500);for(let u=0;u<l&&!e.done;++u){h===this._cycleStartIndex&&this._startUpdateCycle();const u=o.state.get(h);let p=0;if(!(u&S.ALLOCATED)){h=h+1===c?0:h+1,l++;continue}const m=o.lodLevel.get(h);if(u&S.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[m].freeTail(),u&S.HIGHLIGHT_ACTIVE){const e=i.geHighlightOptionsPrev(h);if(e){const t=this._highlightRenderInstanceDataMap.get(e);if(!t)throw new Error.A("Internal error in lodRenderer");t[m].freeTail()}}if(u&S.REMOVE)i.freeInstance(h);else if(u&S.VISIBLE){let e=0;if(t&&(o.modelOrigin.getVec(h,J),e=a.selectLevel(J,i.getCombinedMedianScaleFactor(h),n)),p=u&~(S.ACTIVE|S.TRANSFORM_CHANGED),e>=0)if(u&S.HIGHLIGHT){const t=i.getHighlightName(h);if(t){const n=()=>{const e=this._createRenderInstanceDataArray();return e.forEach((e=>e.beginUpdate())),e},a=(0,MapUtils.tE)(this._highlightRenderInstanceDataMap,t,n);if(e>=a.length)throw new Error.A(`LodRenderer internal error - missing lodLevel ${e}`);W(a[e],o,h)}p|=S.HIGHLIGHT_ACTIVE}else W(this._defaultRenderInstanceData[e],o,h),p|=S.DEFAULT_ACTIVE;o.state.set(h,p),o.lodLevel.set(h,e)}else p=u&~(S.ACTIVE|S.TRANSFORM_CHANGED),o.state.set(h,p);if(null!=this._octreeCached){const e=!!(u&S.ACTIVE),t=!!(p&S.ACTIVE);!e&&t?this._octreeCached.addInstance(h):e&&!t?this._octreeCached.removeInstance(h):e&&t&&u&S.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(h),this._octreeCached.addInstance(h))}h=h+1===c?0:h+1,h%d==0&&e.madeProgress()}this._instanceIndex=h,this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.endUpdate())))),this._context.requestRender()}_beginComponent(e,t,r){if(0===t.size)return null;const n=r.glMaterials.load(e.rctx,e.bind.slot,e.output);return n?.beginSlot(e.bind)}_renderComponent(e,t,r,n,s){if(!t)return;const{bind:a,rctx:i}=e;i.runAppleAmdDriverHelper();const o=i.bindTechnique(t,a,n.material.parameters,te);i.bindVAO(n.vao),t.ensureAttributeLocations(n.vao),debugFlags.b.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===ShaderOutput.V.Color&&(o.setUniform4fv("externalColor",ee[Math.min(s,ee.length-1)]),o.setUniform1i("colorMixMode",MaterialUtil.Um.replace));const l=r.capacity,c=r.headIndex,h=r.tailIndex,d=r.firstIndex,u=this._glInstanceBufferLayout,p=(e,s)=>{(0,webgl_Util.yu)(i,DefaultVertexAttributeLocations.D,r.buffer,u,e),i.drawArraysInstanced(t.primitiveType,0,n.vertexCount,s-e),(0,webgl_Util.Hi)(i,DefaultVertexAttributeLocations.D,r.buffer,u)};n.material.parameters.transparent&&null!=d?c>h?((0,Util.vA)(d>=h&&d<=c,"invalid firstIndex"),p(d,c),p(h,d)):c<h&&(d<=c?((0,Util.vA)(d>=0&&d<=c,"invalid firstIndex"),p(d,c),p(h,l),p(0,d)):((0,Util.vA)(d>=h&&d<=l,"invalid firstIndex"),p(d,l),p(0,c),p(h,d))):c>h?p(h,c):c<h&&(p(0,c),p(h,l)),i.bindVAO(null)}};function W(e,t,r){const n=e.allocateHead();!function K(e,t,r,n){(0,utils.Vk)(e.modelOrigin,t,r.modelOriginHi,r.modelOriginLo,n),r.model.copyFrom(n,e.model,t),r.modelNormal.copyFrom(n,e.modelNormal,t),e.color&&r.color&&r.color.copyFrom(n,e.color,t),e.objectAndLayerIdColor&&r.objectAndLayerIdColor&&r.objectAndLayerIdColor.copyFrom(n,e.objectAndLayerIdColor,t),e.featureAttribute&&r.featureAttribute&&r.featureAttribute.copyFrom(n,e.featureAttribute,t)}(t,r,e.view,n)}(0,tslib_es6._)([(0,property.MZ)({constructOnly:!0})],k.prototype,"symbol",void 0),(0,tslib_es6._)([(0,property.MZ)({constructOnly:!0})],k.prototype,"optionalFields",void 0),(0,tslib_es6._)([(0,property.MZ)({constructOnly:!0})],k.prototype,"metadata",void 0),(0,tslib_es6._)([(0,property.MZ)({constructOnly:!0})],k.prototype,"shaderTransformation",void 0),(0,tslib_es6._)([(0,property.MZ)()],k.prototype,"_instanceData",void 0),(0,tslib_es6._)([(0,property.MZ)()],k.prototype,"_cycleStartIndex",void 0),(0,tslib_es6._)([(0,property.MZ)({readOnly:!0})],k.prototype,"_enableLevelSelection",null),(0,tslib_es6._)([(0,property.MZ)()],k.prototype,"_updateCyclesWithStaticCamera",void 0),(0,tslib_es6._)([(0,property.MZ)({readOnly:!0})],k.prototype,"running",null),k=(0,tslib_es6._)([(0,subclass.$)("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],k);const J=(0,vec3f64.vt)(),Q=(0,vec4f64.vt)(),Z=(0,mat4f64.vt)(),$=(0,vec3f64.vt)(),X=(0,vec3f64.vt)(),ee=[(0,vec4f64.fA)(1,0,1,1),(0,vec4f64.fA)(0,0,1,1),(0,vec4f64.fA)(0,1,0,1),(0,vec4f64.fA)(1,1,0,1),(0,vec4f64.fA)(1,0,0,1)],te=new DefaultMaterialTechnique.V}}]);