"use strict";(self.webpackChunk_defra_flood_map=self.webpackChunk_defra_flood_map||[]).push([[3707],{"./node_modules/@arcgis/core/views/2d/engine/BitmapContainer.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{l:()=>r});var _webgl_enums_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@arcgis/core/views/2d/engine/webgl/enums.js"),_webgl_WGLContainer_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@arcgis/core/views/2d/engine/webgl/WGLContainer.js"),_webgl_shaderGraph_techniques_bitmap_BitmapTechnique_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/@arcgis/core/views/2d/engine/webgl/shaderGraph/techniques/bitmap/BitmapTechnique.js");class r extends _webgl_WGLContainer_js__WEBPACK_IMPORTED_MODULE_1__.A{constructor(){super(...arguments),this._hasCrossfade=!1,this._bitmapTechnique=null}get requiresDedicatedFBO(){return super.requiresDedicatedFBO||this._hasCrossfade}beforeRender(e){super.beforeRender(e),this._manageFade()}onAttach(){super.onAttach(),this._bitmapTechnique=new _webgl_shaderGraph_techniques_bitmap_BitmapTechnique_js__WEBPACK_IMPORTED_MODULE_2__.C}onDetach(){super.onDetach(),this._bitmapTechnique?.shutdown(),this._bitmapTechnique=null}renderChildren(i){super.renderChildren(i),this.visible&&i.drawPhase===_webgl_enums_js__WEBPACK_IMPORTED_MODULE_0__.S5.MAP&&null!=this._bitmapTechnique&&this._bitmapTechnique.render(i,{bitmaps:this.children})}_manageFade(){this.children.reduce(((e,i)=>e+(i.inFadeTransition?1:0)),0)>=2?(this.children.forEach((e=>e.blendFunction="additive")),this._hasCrossfade=!0):(this.children.forEach((e=>e.blendFunction="standard")),this._hasCrossfade=!1)}}},"./node_modules/@arcgis/core/views/2d/layers/ImageryLayerView2D.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>_});var tslib_es6=__webpack_require__("./node_modules/@arcgis/core/chunks/tslib.es6.js"),Graphic=__webpack_require__("./node_modules/@arcgis/core/Graphic.js"),arrayUtils=__webpack_require__("./node_modules/@arcgis/core/core/arrayUtils.js"),Collection=__webpack_require__("./node_modules/@arcgis/core/core/Collection.js"),handleUtils=__webpack_require__("./node_modules/@arcgis/core/core/handleUtils.js"),has=__webpack_require__("./node_modules/@arcgis/core/core/has.js"),reactiveUtils=__webpack_require__("./node_modules/@arcgis/core/core/reactiveUtils.js"),property=__webpack_require__("./node_modules/@arcgis/core/core/accessorSupport/decorators/property.js"),Logger=__webpack_require__("./node_modules/@arcgis/core/core/Logger.js"),subclass=__webpack_require__("./node_modules/@arcgis/core/core/accessorSupport/decorators/subclass.js"),GraphicsCollection=__webpack_require__("./node_modules/@arcgis/core/support/GraphicsCollection.js"),FlowView2D=__webpack_require__("./node_modules/@arcgis/core/views/2d/engine/flow/FlowView2D.js"),LayerView2D=__webpack_require__("./node_modules/@arcgis/core/views/2d/layers/LayerView2D.js"),GraphicsView2D=__webpack_require__("./node_modules/@arcgis/core/views/2d/layers/graphics/GraphicsView2D.js"),HighlightGraphicContainer=__webpack_require__("./node_modules/@arcgis/core/views/2d/layers/graphics/HighlightGraphicContainer.js"),Accessor=__webpack_require__("./node_modules/@arcgis/core/core/Accessor.js"),promiseUtils=__webpack_require__("./node_modules/@arcgis/core/core/promiseUtils.js"),pixelUtils=(__webpack_require__("./node_modules/@arcgis/core/core/RandomLCG.js"),__webpack_require__("./node_modules/@arcgis/core/layers/support/rasterFunctions/pixelUtils.js")),BitmapContainer=__webpack_require__("./node_modules/@arcgis/core/views/2d/engine/BitmapContainer.js"),Container=__webpack_require__("./node_modules/@arcgis/core/views/2d/engine/Container.js"),ImageryBitmapSource=__webpack_require__("./node_modules/@arcgis/core/views/2d/engine/ImageryBitmapSource.js"),ExportStrategy=__webpack_require__("./node_modules/@arcgis/core/views/2d/layers/support/ExportStrategy.js");let m=class extends Accessor.A{constructor(){super(...arguments),this.attached=!1,this.container=new Container.m,this.updateRequested=!1,this.type="imagery",this._bitmapView=new BitmapContainer.l}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(t){this.strategy.update(t).catch((t=>{(0,promiseUtils.zf)(t)||Logger.A.getLogger(this).error(t)}))}hitTest(t){return new Graphic.default({attributes:{},geometry:t.clone(),layer:this.layer})}attach(){this.container.addChild(this._bitmapView);const t=this.layer.version>=10,e=this.layer.version>=10.1?this.layer.imageMaxHeight:2048,i=this.layer.version>=10.1?this.layer.imageMaxWidth:2048;this.strategy=new ExportStrategy.A({container:this._bitmapView,imageNormalizationSupported:t,imageMaxHeight:e,imageMaxWidth:i,fetchSource:this._fetchImage.bind(this),requestUpdate:()=>this.requestUpdate()})}detach(){this.strategy.destroy(),this._bitmapView.removeAllChildren(),this.container.removeAllChildren(),this.updateRequested=!1}redraw(){this.strategy.updateExports((async t=>{const{source:e}=t;if(!e||e instanceof ImageBitmap)return;const i=await this.layer.applyRenderer({extent:e.extent,pixelBlock:e.originalPixelBlock??e.pixelBlock});e.filter=t=>this.layer.pixelFilter?this.layer.applyFilter(t):{...i,extent:e.extent}})).catch((t=>{(0,promiseUtils.zf)(t)||Logger.A.getLogger(this).error(t)}))}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}isUpdating(){return this.strategy.updating||this.updateRequested}getPixelData(){if(this.updating)return null;const t=this.strategy.bitmaps;if(1===t.length&&t[0].source)return{extent:t[0].source.extent,pixelBlock:t[0].source.originalPixelBlock};if(t.length>1){const e=this.view.extent,i=t.map((t=>t.source)).filter((t=>t.extent&&t.extent.intersects(e))).map((t=>({extent:t.extent,pixelBlock:t.originalPixelBlock}))),r=(0,pixelUtils.LY)(i,e);return null!=r?{extent:r.extent,pixelBlock:r.pixelBlock}:null}return null}async _fetchImage(t,e,i,r){(r=r||{}).timeExtent=this.timeExtent,r.requestAsImageElement=!0,r.returnImageBitmap=!0;const s=await this.layer.fetchImage(t,e,i,r);if(s.imageBitmap)return s.imageBitmap;const a=await this.layer.applyRenderer(s.pixelData,{signal:r.signal}),o=new ImageryBitmapSource.A(a.pixelBlock,a.extent?.clone(),s.pixelData.pixelBlock);return o.filter=t=>this.layer.applyFilter(t),o}};(0,tslib_es6._)([(0,property.MZ)()],m.prototype,"attached",void 0),(0,tslib_es6._)([(0,property.MZ)()],m.prototype,"container",void 0),(0,tslib_es6._)([(0,property.MZ)()],m.prototype,"layer",void 0),(0,tslib_es6._)([(0,property.MZ)()],m.prototype,"strategy",void 0),(0,tslib_es6._)([(0,property.MZ)()],m.prototype,"timeExtent",void 0),(0,tslib_es6._)([(0,property.MZ)()],m.prototype,"view",void 0),(0,tslib_es6._)([(0,property.MZ)()],m.prototype,"updateRequested",void 0),(0,tslib_es6._)([(0,property.MZ)()],m.prototype,"updating",null),(0,tslib_es6._)([(0,property.MZ)()],m.prototype,"type",void 0),m=(0,tslib_es6._)([(0,subclass.$)("esri.views.2d.layers.imagery.ImageryView2D")],m);const d=m;var request=__webpack_require__("./node_modules/@arcgis/core/request.js"),Extent=__webpack_require__("./node_modules/@arcgis/core/geometry/Extent.js"),spatialReferenceUtils=__webpack_require__("./node_modules/@arcgis/core/geometry/support/spatialReferenceUtils.js"),rasterProjectionHelper=__webpack_require__("./node_modules/@arcgis/core/layers/support/rasterFunctions/rasterProjectionHelper.js"),vectorFieldUtils=__webpack_require__("./node_modules/@arcgis/core/layers/support/rasterFunctions/vectorFieldUtils.js"),BrushVectorField=__webpack_require__("./node_modules/@arcgis/core/views/2d/engine/imagery/BrushVectorField.js"),enums=__webpack_require__("./node_modules/@arcgis/core/views/2d/engine/webgl/enums.js"),WGLContainer=__webpack_require__("./node_modules/@arcgis/core/views/2d/engine/webgl/WGLContainer.js");class t extends WGLContainer.A{constructor(){super(...arguments),this.symbolTypes=["triangle"]}prepareRenderPasses(s){const t=s.registerRenderPass({name:"imagery (vf)",brushes:[BrushVectorField.A],target:()=>this.children,drawPhase:enums.S5.MAP});return[...super.prepareRenderPasses(s),t]}doRender(e){this.visible&&e.drawPhase===enums.S5.MAP&&this.symbolTypes.forEach((r=>{e.renderPass=r,super.doRender(e)}))}}var RasterVFDisplayObject=__webpack_require__("./node_modules/@arcgis/core/views/2d/engine/imagery/RasterVFDisplayObject.js");let c=class extends Accessor.A{constructor(e){super(e),this._loading=null,this.update=(0,promiseUtils.sg)(((e,t)=>this._update(e,t).catch((e=>{(0,promiseUtils.zf)(e)||Logger.A.getLogger(this).error(e)}))))}get updating(){return!!this._loading}redraw(e){if(!this.container.children.length)return;const t=this.container.children[0];t.symbolizerParameters=e,t.invalidateVAO(),this.container.symbolTypes="wind_speed"===e.style?["scalar","triangle"]:"simple_scalar"===e.style?["scalar"]:["triangle"],this.container.requestRender()}async _update(e,t,i){if(!e.stationary)return;const{extent:r,spatialReference:o}=e.state,s=new Extent.default({xmin:r.xmin,ymin:r.ymin,xmax:r.xmax,ymax:r.ymax,spatialReference:o}),[a,l]=e.state.size;this._loading=this.fetchPixels(s,a,l,i);const c=await this._loading;this._addToDisplay(c,t,e.state),this._loading=null}_addToDisplay(e,t,i){if(null==e.pixelBlock)return this.container.children.forEach((e=>e.destroy())),void this.container.removeAllChildren();const{extent:r,pixelBlock:o}=e,s=new RasterVFDisplayObject.X(o);s.offset=[0,0],s.symbolizerParameters=t,s.rawPixelData=e,s.invalidateVAO(),s.x=r.xmin,s.y=r.ymax,s.pixelRatio=i.pixelRatio,s.rotation=i.rotation,s.resolution=i.resolution,s.width=o.width*t.symbolTileSize,s.height=o.height*t.symbolTileSize,this.container.children.forEach((e=>e.destroy())),this.container.removeAllChildren(),this.container.symbolTypes="wind_speed"===t.style?["scalar","triangle"]:"simple_scalar"===t.style?["scalar"]:["triangle"],this.container.addChild(s)}};(0,tslib_es6._)([(0,property.MZ)()],c.prototype,"fetchPixels",void 0),(0,tslib_es6._)([(0,property.MZ)()],c.prototype,"container",void 0),(0,tslib_es6._)([(0,property.MZ)()],c.prototype,"_loading",void 0),(0,tslib_es6._)([(0,property.MZ)()],c.prototype,"updating",null),c=(0,tslib_es6._)([(0,subclass.$)("esri.views.2d.layers.imagery.ImageryVFStrategy")],c);const p=c;let f=class extends Accessor.A{constructor(){super(...arguments),this.attached=!1,this.container=new t,this.type="imageryVF",this._dataParameters={exportParametersVersion:0,bbox:"",symbolTileSize:0,time:""},this._fetchpixels=async(t,e,r,i)=>{const s=await this._projectFullExtentPromise,{symbolTileSize:a}=this.layer.renderer,{extent:o,width:n,height:l}=(0,vectorFieldUtils.$Q)(t,e,r,a,s);if(null!=s&&!s.intersects(t))return{extent:o,pixelBlock:null};const m={bbox:`${o.xmin}, ${o.ymin}, ${o.xmax}, ${o.ymax}`,exportParametersVersion:this.layer.exportImageServiceParameters.version,symbolTileSize:a,time:JSON.stringify(this.timeExtent||"")};if(this._canReuseVectorFieldData(m)){const t=this.getPixelData();if(null!=t&&`${t.extent.xmin}, ${t.extent.ymin}, ${t.extent.xmax}, ${t.extent.ymax}`===m.bbox)return t}const{pixelData:c}=await this.layer.fetchImage(o,n,l,{timeExtent:this.timeExtent,requestAsImageElement:!1,signal:i});this._dataParameters=m;const p=c?.pixelBlock;return null==p?{extent:o,pixelBlock:null}:{extent:o,pixelBlock:"vector-uv"===this.layer.rasterInfo.dataType?(0,vectorFieldUtils.FI)(p,"vector-uv"):p}}}get updating(){return!this.attached||this._strategy.updating}attach(){this._projectFullExtentPromise=this._getProjectedFullExtent(this.view.spatialReference),this._strategy=new p({container:this.container,fetchPixels:this._fetchpixels}),this.addHandles((0,reactiveUtils.watch)((()=>this.layer.renderer),(t=>this._updateSymbolizerParams(t)),reactiveUtils.pc),"attach")}detach(){this._strategy.destroy(),this.container.children.forEach((t=>t.destroy())),this.container.removeAllChildren(),this.removeHandles("attach"),this._strategy=this.container=this._projectFullExtentPromise=null}getPixelData(){const t=this.container.children[0]?.rawPixelData;if(this.updating||!t)return null;const{extent:e,pixelBlock:r}=t;return{extent:e,pixelBlock:r}}hitTest(t){return new Graphic.default({attributes:{},geometry:t.clone(),layer:this.layer})}update(t){this._strategy.update(t,this._symbolizerParams).catch((t=>{(0,promiseUtils.zf)(t)||Logger.A.getLogger(this).error(t)}))}redraw(){const{renderer:t}=this.layer;t&&(this._updateSymbolizerParams(t),this._strategy.redraw(this._symbolizerParams))}_canReuseVectorFieldData(t){const e=this._dataParameters.exportParametersVersion===t.exportParametersVersion,r=this._dataParameters.time===t.time,i=this._dataParameters.symbolTileSize===t.symbolTileSize,s=this._dataParameters.bbox===t.bbox;return e&&r&&i&&s}async _getProjectedFullExtent(t){try{return(0,rasterProjectionHelper._l)(this.layer.fullExtent,t)}catch(e){try{const e=(await(0,request.A)(this.layer.url,{query:{option:"footprints",outSR:(0,spatialReferenceUtils.YX)(t),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return e?Extent.default.fromJSON(e):null}catch{return null}}}_updateSymbolizerParams(t){"vector-field"===t?.type&&(this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null}))}};(0,tslib_es6._)([(0,property.MZ)()],f.prototype,"attached",void 0),(0,tslib_es6._)([(0,property.MZ)()],f.prototype,"container",void 0),(0,tslib_es6._)([(0,property.MZ)()],f.prototype,"layer",void 0),(0,tslib_es6._)([(0,property.MZ)()],f.prototype,"timeExtent",void 0),(0,tslib_es6._)([(0,property.MZ)()],f.prototype,"type",void 0),(0,tslib_es6._)([(0,property.MZ)()],f.prototype,"view",void 0),(0,tslib_es6._)([(0,property.MZ)()],f.prototype,"updating",null),f=(0,tslib_es6._)([(0,subclass.$)("esri.views.2d.layers.imagery.VectorFieldView2D")],f);const g=f;var Error=__webpack_require__("./node_modules/@arcgis/core/core/Error.js"),Point=__webpack_require__("./node_modules/@arcgis/core/geometry/Point.js"),timeSupport=__webpack_require__("./node_modules/@arcgis/core/layers/support/timeSupport.js"),Query=__webpack_require__("./node_modules/@arcgis/core/rest/support/Query.js"),popupUtils=__webpack_require__("./node_modules/@arcgis/core/views/layers/support/popupUtils.js");const ImageryLayerView_m=m=>{let l=class extends m{constructor(){super(...arguments),this.view=null}get timeExtent(){return(0,timeSupport.F)(this.layer,this.view?.timeExtent,this._get("timeExtent"))}async fetchPopupFeaturesAtLocation(e,o){const{layer:s}=this;if(!e)throw new Error.A("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:a}=s,p=(0,popupUtils.D8)(s,o);if(!a||null==p)return[];const n=await p.getRequiredFields();(0,promiseUtils.Te)(o);const m=new Query.A;m.timeExtent=this.timeExtent,m.geometry=e,m.outFields=n,m.outSpatialReference=e.spatialReference;const{resolution:l,spatialReference:y}=this.view,h="2d"===this.view.type?new Point.default(l,l,y):new Point.default(.5*l,.5*l,y),{returnTopmostRaster:f,showNoDataRecords:w}=p.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},d={returnDomainValues:!0,returnTopmostRaster:f,pixelSize:h,showNoDataRecords:w,signal:o?.signal};return s.queryVisibleRasters(m,d).then((e=>e))}async getSourceScale(){return await(0,rasterProjectionHelper.Hh)(),await this.layer.load(),(0,rasterProjectionHelper.OO)(this.layer.serviceRasterInfo,this.view.spatialReference)}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return(0,tslib_es6._)([(0,property.MZ)()],l.prototype,"layer",void 0),(0,tslib_es6._)([(0,property.MZ)()],l.prototype,"suspended",void 0),(0,tslib_es6._)([(0,property.MZ)({readOnly:!0})],l.prototype,"timeExtent",null),(0,tslib_es6._)([(0,property.MZ)()],l.prototype,"view",void 0),l=(0,tslib_es6._)([(0,subclass.$)("esri.views.layers.ImageryLayerView")],l),l};var LayerView=__webpack_require__("./node_modules/@arcgis/core/views/layers/LayerView.js"),RefreshableLayerView=__webpack_require__("./node_modules/@arcgis/core/views/layers/RefreshableLayerView.js"),HighlightDefaults=__webpack_require__("./node_modules/@arcgis/core/views/support/HighlightDefaults.js");let b=class extends(ImageryLayerView_m((0,RefreshableLayerView.A)((0,LayerView2D.e)(LayerView.A)))){constructor(){super(...arguments),this._exportImageVersion=-1,this._highlightGraphics=new GraphicsCollection.Y,this._highlightView=void 0,this.layer=null,this.subview=null}get pixelData(){const{subview:e}=this;return this.updating||!e?null:"getPixelData"in e?e.getPixelData():null}update(e){this.subview?.update(e)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.view&&(this._highlightView=new GraphicsView2D.A({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new HighlightGraphicContainer.A(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container)),this.addAttachHandles([(0,reactiveUtils.watch)((()=>this.layer.exportImageServiceParameters.version),(e=>{e&&this._exportImageVersion!==e&&(this._exportImageVersion=e,this.requestUpdate())}),reactiveUtils.OH),(0,reactiveUtils.watch)((()=>this.timeExtent),(e=>{const{subview:i}=this;i&&(i.timeExtent=e,"redraw"in i?this.requestUpdate():i.redrawOrRefetch())}),reactiveUtils.OH),this.layer.on("redraw",(()=>{const{subview:e}=this;e&&("redraw"in e?e.redraw():e.redrawOrRefetch())})),(0,reactiveUtils.watch)((()=>this.layer.renderer),(()=>this._setSubView()))])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this.container.removeAllChildren(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null,this._highlightView?.destroy(),this._exportImageVersion=-1}viewChange(){}moveEnd(){this.requestUpdate()}highlight(e,h){if(!((Array.isArray(e)?e[0]:Collection.A.isCollection(e)?e.at(0):e)instanceof Graphic.default))return(0,handleUtils.hA)();let a=[];Array.isArray(e)||Collection.A.isCollection(e)?a=e.map((e=>e.clone())):e instanceof Graphic.default&&(a=[e.clone()]);const o=a?.filter(arrayUtils.Ru);if(!o?.length)return(0,handleUtils.hA)();const l=h?.name??HighlightDefaults.Tv;return this._addHighlightGraphics(a,l),(0,handleUtils.hA)((()=>!this.destroyed&&this._removeHighlightGraphics(a,l)))}_addHighlightGraphics(e,i){this._highlightGraphics.addMany(e),this._addHighlights(e.map((e=>e.uid)),i)}_removeHighlightGraphics(e,i){this._highlightGraphics.removeMany(e),this._removeHighlights(e.map((e=>e.uid)),i)}async doRefresh(){this.requestUpdate()}isUpdating(){const e=!this.subview||this.subview.updating||!!this._highlightView?.updating;return(0,has.A)("esri-2d-log-updating")&&console.log(`Updating ImageryLayerView2D (${this.layer.id}): ${e}\n-> subview ${!this.subview||this.subview.updating}\n-> higlightView ${this._highlightView?.updating}\n`),e}_processHighlight(){const e=this._getHighlights();this._highlightView?.setHighlight(e)}_setSubView(){if(!this.view)return;const e=this.layer.renderer?.type;let i="imagery";if("vector-field"===e?i="imageryVF":"flow"===e&&(i="flow"),this.subview){const{type:e}=this.subview;if(e===i)return this._attachSubview(this.subview),void("flow"===e?this.subview.redrawOrRefetch():"imagery"===e&&"lerc"===this.layer.format?this.subview.redraw():this.requestUpdate());this._detachSubview(this.subview),this.subview?.destroy()}this.subview="imagery"===i?new d({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):"imageryVF"===i?new g({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new FlowView2D.A({layer:this.layer,layerView:this}),this._attachSubview(this.subview),this.requestUpdate()}_attachSubview(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0))}_detachSubview(e){e?.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)}};(0,tslib_es6._)([(0,property.MZ)()],b.prototype,"pixelData",null),(0,tslib_es6._)([(0,property.MZ)()],b.prototype,"subview",void 0),b=(0,tslib_es6._)([(0,subclass.$)("esri.views.2d.layers.ImageryLayerView2D")],b);const _=b},"./node_modules/@arcgis/core/views/2d/layers/support/ExportStrategy.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>_});var tslib_es6=__webpack_require__("./node_modules/@arcgis/core/chunks/tslib.es6.js"),Accessor=__webpack_require__("./node_modules/@arcgis/core/core/Accessor.js"),promiseUtils=(__webpack_require__("./node_modules/@arcgis/core/core/has.js"),__webpack_require__("./node_modules/@arcgis/core/core/promiseUtils.js")),property=__webpack_require__("./node_modules/@arcgis/core/core/accessorSupport/decorators/property.js"),subclass=(__webpack_require__("./node_modules/@arcgis/core/core/Logger.js"),__webpack_require__("./node_modules/@arcgis/core/core/RandomLCG.js"),__webpack_require__("./node_modules/@arcgis/core/core/accessorSupport/decorators/subclass.js")),aaBoundingRect=__webpack_require__("./node_modules/@arcgis/core/geometry/support/aaBoundingRect.js"),spatialReferenceUtils=__webpack_require__("./node_modules/@arcgis/core/geometry/support/spatialReferenceUtils.js"),TileInfo=__webpack_require__("./node_modules/@arcgis/core/layers/support/TileInfo.js");const t=Math.PI/180;function n(n){return n*t}function o(t,o){const a=n(o.rotation),r=Math.abs(Math.cos(a)),s=Math.abs(Math.sin(a)),[u,c]=o.size;return t[0]=Math.round(c*s+u*r),t[1]=Math.round(c*r+u*s),t}var Bitmap=__webpack_require__("./node_modules/@arcgis/core/views/2d/engine/Bitmap.js"),TileInfoView=__webpack_require__("./node_modules/@arcgis/core/views/2d/tiling/TileInfoView.js"),TileKey=__webpack_require__("./node_modules/@arcgis/core/views/2d/tiling/TileKey.js");const y=(0,aaBoundingRect.vt)(),x=[0,0],S=new TileKey.A(0,0,0,0),w_imageMaxWidth=2048,w_imageMaxHeight=2048,w_imageRotationSupported=!1,w_imageNormalizationSupported=!1,w_hidpi=!1;let M=class extends Accessor.A{constructor(t){super(t),this._imagePromise=null,this.bitmaps=[],this.hidpi=w_hidpi,this.imageMaxWidth=w_imageMaxWidth,this.imageMaxHeight=w_imageMaxHeight,this.imageRotationSupported=w_imageRotationSupported,this.imageNormalizationSupported=w_imageNormalizationSupported,this.update=(0,promiseUtils.sg)((async(t,e)=>{if((0,promiseUtils.Te)(e),!t.stationary||this.destroyed)return;const i=t.state,s=(0,spatialReferenceUtils.Vp)(i.spatialReference),a=this.hidpi?t.pixelRatio:1,n=i.worldScreenWidth>0,p=n&&this.imageNormalizationSupported&&i.worldScreenWidth<i.size[0],m=Math.round((this.imageMaxWidth??0)/a),l=Math.round((this.imageMaxHeight??0)/a);p?(x[0]=i.worldScreenWidth,x[1]=i.size[1]):this.imageRotationSupported?(x[0]=i.size[0],x[1]=i.size[1]):o(x,i);const c=Math.floor(x[0])>m||Math.floor(x[1])>l,u=s&&(i.extent.xmin<s.valid[0]||i.extent.xmax>s.valid[1]),g=!this.imageNormalizationSupported&&u,f=!c&&!g,y=this.imageRotationSupported?i.rotation:0,S=this.container.children.slice();if(f){const t=p?i.paddedViewState.center:i.center;this._imagePromise=this._singleExport(i,x,t,i.resolution,y,a,e)}else{let t=Math.min(m,l);n&&(t=Math.min(i.worldScreenWidth,t),t=Math.round(i.worldScreenWidth/Math.ceil(i.worldScreenWidth/t))),this._imagePromise=this._tiledExport(i,t,a,e)}try{const t=await this._imagePromise??[];(0,promiseUtils.Te)(e);const i=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=t;for(const e of S)t.includes(e)||i.push(e.fadeOut().then((()=>{e.remove(),e.destroy()})));for(const e of t)i.push(e.fadeIn());await Promise.all(i)}catch(w){this._imagePromise=null,(0,promiseUtils.QP)(w)}}),5e3),this.updateExports=(0,promiseUtils.sg)((async t=>{const e=[];for(const i of this.container.children){if(!i.visible||!i.stage)return;e.push(t(i).then((()=>{i.invalidateTexture(),i.requestRender()})))}this._imagePromise=(0,promiseUtils.Lx)(e).then((()=>this._imagePromise=null)),await this._imagePromise}))}destroy(){this.bitmaps.forEach((t=>t.destroy())),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(t,e,i,r,s,a){const n=await this.fetchSource(t,Math.floor(e*s),Math.floor(i*s),{rotation:r,pixelRatio:s,signal:a});(0,promiseUtils.Te)(a);const p=new Bitmap.mb(null,!0);return p.x=t.xmin,p.y=t.ymax,p.resolution=t.width/e,p.rotation=r,p.pixelRatio=s,p.opacity=0,this.container.addChild(p),await p.setSourceAsync(n,a),(0,promiseUtils.Te)(a),p}async _singleExport(t,e,i,o,r,s,a){!function viewStateUtils_a(t,n,o,a){const[r,s]=n,[u,c]=a,h=.5*o;return t[0]=r-h*u,t[1]=s-h*c,t[2]=r+h*u,t[3]=s+h*c,t}(y,i,o,e);const n=(0,aaBoundingRect.w1)(y,t.spatialReference);return[await this._export(n,e[0],e[1],r,s,a)]}_tiledExport(t,e,i,o){const r=TileInfo.default.create({size:e,spatialReference:t.spatialReference,scales:[t.scale]}),s=new TileInfoView.A(r),a=s.getTileCoverage(t);if(!a)return null;const n=[];return a.forEach(((r,a,p,h)=>{S.set(r,a,p,0),s.getTileBounds(y,S);const l=(0,aaBoundingRect.w1)(y,t.spatialReference);n.push(this._export(l,e,e,0,i,o).then((t=>(0!==h&&(S.set(r,a,p,h),s.getTileBounds(y,S),t.x=y[0],t.y=y[3]),t))))})),Promise.all(n)}};(0,tslib_es6._)([(0,property.MZ)()],M.prototype,"_imagePromise",void 0),(0,tslib_es6._)([(0,property.MZ)()],M.prototype,"bitmaps",void 0),(0,tslib_es6._)([(0,property.MZ)()],M.prototype,"container",void 0),(0,tslib_es6._)([(0,property.MZ)()],M.prototype,"fetchSource",void 0),(0,tslib_es6._)([(0,property.MZ)()],M.prototype,"hidpi",void 0),(0,tslib_es6._)([(0,property.MZ)()],M.prototype,"imageMaxWidth",void 0),(0,tslib_es6._)([(0,property.MZ)()],M.prototype,"imageMaxHeight",void 0),(0,tslib_es6._)([(0,property.MZ)()],M.prototype,"imageRotationSupported",void 0),(0,tslib_es6._)([(0,property.MZ)()],M.prototype,"imageNormalizationSupported",void 0),(0,tslib_es6._)([(0,property.MZ)()],M.prototype,"requestUpdate",void 0),(0,tslib_es6._)([(0,property.MZ)()],M.prototype,"updating",null),M=(0,tslib_es6._)([(0,subclass.$)("esri.views.2d.layers.support.ExportStrategy")],M);const _=M}}]);